name: build-openvisus
on: [push]
jobs:

  # ///////////////////////////////////////////////////////////////////
  build-openvisus-windows-cpython:
    runs-on: "windows-latest"
    strategy:
      fail-fast: false  
      matrix:
        #  REMOVED '3.10' since PyQt5 it's not yet available for windows
        python-version: [ '3.6', '3.7', '3.8', '3.9' ]  
    steps:
    
    - name: git clone OpenVisus
      uses: actions/checkout@v2

    - name: Install CMake 
      uses: lukka/get-cmake@latest

    # choco install python --version 3.8.0
    - name: Install CPython 
      uses: actions/setup-python@v2
      with:
        python-version: ${{ matrix.python-version }} 
        architecture: 'x64'

    - name: Install Qt
      uses: jurplel/install-qt-action@v2
      with:
        version: '5.12.8'
        arch: 'win64_msvc2017_64'
        install-deps: 'true'
        dir: C:\
        setup-python: 'false' 
        
    - name: Compile (cpython)
      shell: bash
      env: 
        PYTHON_VERSION: ${{ matrix.python-version }}
        PYPI_USERNAME: ${{ secrets.PYPI_USERNAME }}
        PYPI_PASSWORD: ${{ secrets.PYPI_PASSWORD }}
      run: |
           source ./scripts/build_windows.cpython.sh
            
  # ///////////////////////////////////////////////////////////////////
  build-openvisus-windows-conda:
    runs-on: "windows-latest"
    strategy:
      fail-fast: false  
      matrix:
        #  REMOVED '3.10' since PyQt5 it's not yet available for windows
        # REMOVED 3.6 sice SyntaxError: future feature annotations is not defined
        python-version: [ '3.7', '3.8', '3.9' ] 
    steps:
    
    - name: git clone OpenVisus
      uses: actions/checkout@v2

    - name: Install CMake 
      uses: lukka/get-cmake@latest

    - name: Install Miniconda 
      uses: conda-incubator/setup-miniconda@v2
      continue-on-error: true # if fails the cleaning process
      with:
        miniconda-version: 'latest'
        python-version: ${{ matrix.python-version }}
        activate-environment: my-env
        auto-update-conda: false
        channels: conda-forge,defaults

    - name: Compile (conda)
      shell: bash -l {0}
      env: 
        PYTHON_VERSION: ${{ matrix.python-version }}
        ANACONDA_TOKEN: ${{ secrets.ANACONDA_TOKEN }}
      run: |
           source scripts/build_windows.conda.sh

  # ///////////////////////////////////////////////////////////////////
  build-openvisus-macos-cpython:
    runs-on: "macos-latest"
    strategy:
      fail-fast: false  
      matrix:
        # 3.6 disabled since "Error: Version 3.6 with arch x64 not found "
        python-version: [ '3.7', '3.8', '3.9', '3.10']  
    steps:
    
    - name: git clone OpenVisus
      uses: actions/checkout@v2
     
    # brew install python@3.7
    - name: Install CPython 
      uses: actions/setup-python@v2
      with:
        python-version: ${{ matrix.python-version }} 
        architecture: 'x64'

    # I can do also
    # python -m pip install aqtinstall
    # python -m aqt install-qt windows desktop 5.12.0 win64_msvc2017_64
    # C:\projects\OpenVisus\5.12.0\msvc2017_64\bin\qmake.exe
    - name: Install Qt
      uses: jurplel/install-qt-action@v2
      with:
        version: '5.12.8'
        target: 'desktop'
        install-deps: 'true'
        dir: /tmp
        setup-python: 'false'

    - name: Compile cpython
      env:
        PYTHON_VERSION: ${{ matrix.python-version }}
        PYPI_USERNAME: ${{ secrets.PYPI_USERNAME }}
        PYPI_PASSWORD: ${{ secrets.PYPI_PASSWORD }}
      shell: bash
      run: |
           source scripts/build_macos.cpython.sh
            
  # ///////////////////////////////////////////////////////////////////
  build-openvisus-macos-conda:
    runs-on: "macos-latest"
    strategy:
      fail-fast: false  
      matrix:
        python-version: [ '3.7', '3.8', '3.9', '3.10']  
    steps:
    
    - name: git clone OpenVisus
      uses: actions/checkout@v2
     
    - name: Install Miniconda 
      uses: conda-incubator/setup-miniconda@v2
      continue-on-error: true # if fails the cleaning process
      with:
        miniconda-version: 'latest'
        python-version: ${{ matrix.python-version }}
        activate-environment: my-env
        auto-update-conda: false
        channels: conda-forge,defaults

    - name: Build (conda)
      env:
        PYTHON_VERSION: ${{ matrix.python-version }}
        ANACONDA_TOKEN: ${{ secrets.ANACONDA_TOKEN }}
      shell: bash -l {0}
      run: |
           source scripts/build_macos.conda.sh

  # ///////////////////////////////////////////////////////////////////
  build-openvisus-ubuntu:
    runs-on: "ubuntu-latest"
    strategy:
      fail-fast: false  
      matrix:
        # '3.6' disabled SyntaxError: future feature annotations is not defined
        python-version: [ '3.7', '3.8', '3.9', '3.10' ]
    steps:
    - name: git clone OpenVisus
      uses: actions/checkout@v2

    - name: Compile cpython
      shell: bash
      env:
        VISUS_GUI: 1
        VISUS_SLAM: 1
        VISUS_MODVISUS: 1
        PYTHON_VERSION: ${{ matrix.python-version }}
        PYPI_USERNAME: ${{ secrets.PYPI_USERNAME }}
        PYPI_PASSWORD: ${{ secrets.PYPI_PASSWORD }}
        ANACONDA_TOKEN: ${{ secrets.ANACONDA_TOKEN }}
        DOCKER_USERNAME: ${{ secrets.DOCKER_USERNAME }}
        DOCKER_TOKEN: ${{ matrix.python-version }}
        PULL_IMAGE: visus/portable-linux-binaries_x86_64:4.1
        PUSH_IMAGE: visus/mod_visus
      run: |
           source scripts/build_ubuntu.sh










