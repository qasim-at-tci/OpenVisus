version: 2.1
commands:

jobs:
  build-openvisus:
    machine:
      image: << parameters.os >>    
    steps:
      - checkout
      - run:
          name: Build OpenVisus
          command: | 
            set -e
            set -x          

            # Setup buildx and qemu
            sudo apt-get update  -qq
            sudo apt-get install -qq -y qemu-user-static
            sudo apt-get install -qq -y binfmt-support

            # check version
            qemu-aarch64-static --version
            update-binfmts --version 

            # create buikder hyst ub case
            export DOCKER_CLI_EXPERIMENTAL=1
            # docker buildx create --name my-builder
            # docker buildx use my-builder
            # docker buildx inspect --bootstrap       

            PYTHON_VERSION=<< parameters.python-version >>    

            sudo docker run --rm --platform linux/arm64 \
              -v $PWD:/home/OpenVisus -w /home/OpenVisus \
              -e PYTHON_VERSION=${PYTHON_VERSION} -e PYPI_PASSWORD=${PYPI_PASSWORD} -e ANACONDA_TOKEN=${ANACONDA_TOKEN}  \
              nsdf/manylinux2014_aarch64:latest bash scripts/build_linux.arm64.sh            

workflows:
  version: 2
  build:
    jobs:
      - build-openvisus:
          matrix:
            parameters:
              python-version: ['3.7', '3.8', '3.9' ,'3.10']
              os: ['ubuntu-2004:202010-01'] # this is ubuntu 20.04

           

      

